require('dotenv').config();
const { Client, MessageMedia, Location } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const qrcodeDataUrl = require('qrcode');
const fs = require('fs');
const express = require('express');
const path = require('path');
const axios = require('axios');
const { GoogleGenerativeAI } = require('@google/generative-ai');

// Express App Setup
const app = express();
const PORT = process.env.PORT || 3000;
app.use(express.json());

// Vari√°veis globais para QR e status
let lastQR = null;
let clientReady = false;
let lastError = null;

// Health check route (OBRIGAT√ìRIO para Railway)
app.get("/health", (req, res) => {
    res.json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: Math.floor(process.uptime()),
        memory: process.memoryUsage(),
        whatsapp: clientReady ? 'connected' : 'disconnected'
    });
});

// Rota principal
app.get("/", (req, res) => {
    res.json({
        status: 'Travel Boss AI Bot is running! ü§ñ',
        timestamp: new Date().toISOString(),
        uptime: Math.floor(process.uptime()),
        version: '2.0.1',
        platform: 'Railway',
        whatsapp: clientReady ? 'Connected' : 'Connecting...'
    });
});

// Rota para visualizar QR Code no navegador
app.get("/qr", async (req, res) => {
    if (!lastQR) {
        return res.send(`
            <html>
                <head>
                    <title>Travel Boss QR Code</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                </head>
                <body style="text-align: center; padding: 50px; font-family: Arial;">
                    <h1>üîç QR Code WhatsApp</h1>
                    <p>Nenhum QR Code dispon√≠vel no momento.</p>
                    <p>Status: ${clientReady ? 'Conectado' : 'Aguardando conex√£o...'}</p>
                    <button onclick="location.reload()">Atualizar</button>
                </body>
            </html>
        `);
    }
    
    try {
        const dataUrl = await qrcodeDataUrl.toDataURL(lastQR);
        res.send(`
            <html>
                <head>
                    <title>Travel Boss QR Code</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                </head>
                <body style="text-align: center; padding: 50px; font-family: Arial;">
                    <h1>üì± Escaneie com WhatsApp</h1>
                    <img src="${dataUrl}" style="max-width: 300px;" />
                    <p>Use o WhatsApp do celular para escanear</p>
                    <button onclick="location.reload()">Atualizar QR</button>
                    <br><br>
                    <small>Travel Boss AI Bot - Railway</small>
                </body>
            </html>
        `);
    } catch (error) {
        res.send(`
            <html>
                <body>
                    <h1>Erro ao gerar QR Code</h1>
                    <p>${error.message}</p>
                </body>
            </html>
        `);
    }
});

// Rota de status detalhado
app.get("/status", (req, res) => {
    const stats = analytics.getStats();
    const aiStats = aiService.getStats();
    
    res.json({
        system: {
            status: 'running',
            platform: 'Railway',
            uptime: Math.floor(process.uptime()),
            memory: process.memoryUsage(),
            timestamp: new Date().toISOString()
        },
        whatsapp: {
            connected: clientReady,
            hasQR: !!lastQR,
            lastError: lastError
        },
        ai: {
            provider: aiStats.provider,
            activeConversations: aiStats.activeConversations
        },
        analytics: stats
    });
});

// Iniciar servidor Express
app.listen(PORT, '0.0.0.0', () => {
    console.log(`ü©∫ Railway server running on port ${PORT}`);
    console.log(`üåê Health: https://your-app.railway.app/health`);
    console.log(`üîç QR Code: https://your-app.railway.app/qr`);
});

// Configura√ß√£o Puppeteer otimizada para Railway
const puppeteerConfig = {
    headless: true,
    args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--single-process',
        '--disable-gpu',
        '--disable-web-security',
        '--disable-features=VizDisplayCompositor'
    ]
};

// Configura√ß√µes da empresa
const config = {
    empresa: {
        nome: "Travel Boss",
        endereco: "Avenida Fidel Castro, Kikuxi Shopping, 2¬∫ Piso",
        horario: "Segunda a Sexta: 8h √†s 17h | S√°bado: 8h √†s 13h",
        telefone: "+244 922 254 236",
        email: "geral@travelboss.gdmao.com",
        site: "www.travelboss.gdmao.com"
    },
    localizacao: {
        latitude: -8.976940,
        longitude: 13.366880,
        nome: "Travel Boss - Kikuxi Shopping",
        googleMapsUrl: "https://maps.google.com/?q=-8.976940,13.366880"
    },
    images: {
        logo: path.join(__dirname, 'images', 'logo.png'),
        gallery: [
            path.join(__dirname, 'images', 'photo1.jpg'),
            path.join(__dirname, 'images', 'photo2.jpg'),
            path.join(__dirname, 'images', 'photo3.jpg')
        ]
    }
};

// AI Configuration
const AI_CONFIG = {
    google: {
        apiKey: process.env.GOOGLE_AI_KEY,
        model: 'gemini-1.5-flash'
    },
    openai: {
        apiKey: process.env.OPENAI_API_KEY,
        model: 'gpt-3.5-turbo',
        baseURL: 'https://api.openai.com/v1/chat/completions'
    },
    anthropic: {
        apiKey: process.env.ANTHROPIC_API_KEY,
        model: 'claude-3-haiku-20240307',
        baseURL: 'https://api.anthropic.com/v1/messages'
    },
    provider: process.env.AI_PROVIDER || 'google'
};

// Sistema de persist√™ncia da sess√£o
const SESSION_FILE = './session.json';

function saveSession(sessionData) {
    try {
        fs.writeFileSync(SESSION_FILE, JSON.stringify(sessionData, null, 2));
        console.log('‚úÖ Sess√£o WhatsApp salva');
    } catch (error) {
        console.error('‚ùå Erro ao salvar sess√£o:', error.message);
    }
}

function loadSession() {
    try {
        if (fs.existsSync(SESSION_FILE)) {
            const sessionData = JSON.parse(fs.readFileSync(SESSION_FILE));
            console.log('‚úÖ Sess√£o WhatsApp carregada');
            return sessionData;
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar sess√£o:', error.message);
    }
    return null;
}

// Prompt do sistema
const SYSTEM_PROMPT = `Voc√™ √© o TravelBot da Travel Boss, uma ag√™ncia de viagens especializada em vistos localizada em Luanda, Angola, voc√™ foi criado por Gilson Domingos.

INFORMA√á√ïES DA EMPRESA:
- Nome: Travel Boss
- Localiza√ß√£o: Kikuxi Shopping, 2¬∫ Piso, Luanda
- Telefone: +244 922 254 236
- Email: geral@travelboss.gdmao.com
- Hor√°rio: Segunda a Sexta: 8h √†s 17h | S√°bado: 8h √†s 13h

ESPECIALIDADES E PRE√áOS (em Kwanza):
PORTUGAL:
- Visto Procura de Trabalho: 950.000 KZ (entrada normal)
- Visto Turismo: 700.000 KZ (normal) / 1.000.000 KZ (direto)
- Visto Estudante Ensino Superior: 2.000.000 KZ
- Visto Trabalho com Contrato Cliente: 950.000 KZ (normal) / 1.150.000 KZ (direto)
- Visto Trabalho com Nosso Contrato: 1.850.000 KZ (normal) / 2.050.000 KZ (direto)
- Visto Sa√∫de com Nossa Guia: 1.350.000 KZ (normal) / 1.550.000 KZ (direto)
- Visto Sa√∫de com Guia Cliente: 800.000 KZ (normal) / 1.100.000 KZ (direto)

OUTROS PA√çSES:
- Brasil: Turismo/Sa√∫de 1.300.000 KZ, Trabalho 1.650.000 KZ
- EUA: Trabalho 1.150.000 KZ, Estudante 2.150.000 KZ
- Canad√°: Turismo 1.150.000 KZ, Estudante/Trabalho 1.850.000 KZ
- Uni√£o Europeia: Turismo 700.000 KZ, Estudante 1.650.000 KZ

PERSONALIDADE:
- Seja sempre educado, prestativo e profissional
- Use emojis apropriados para tornar a conversa amig√°vel
- Responda em portugu√™s angolano
- Seja direto mas acolhedor
- n√£o precisa dizer sempre ol√°, sempre que enviar uma mensagem, mande s√≥ se o cliente mandar uma sauda√ß√£o ou ativar-te.
- Quando n√£o souber algo espec√≠fico, encaminhe para contato humano
- Sempre ofere√ßa ajuda adicional
- fale muitas linguas: idioma pt - Portugu√™s, idioma en - ingl√™s, idioma es - Espanhol, idioma fr - Fran√ß√™s, idioma russo, italiano, kimbundu, alem√£o.

COMANDOS ESPECIAIS:
- Se disser "PARAR", "STOP": pause o bot e informe contato
- Se disser "MENU" ou "INICIAR": mostre op√ß√µes principais
- Se disser "IMAGEM" ou "LOGO": envie a logo da empresa
- Se disser "GALERIA" ou "FOTOS": envie a galeria de fotos
- Se disser "LOCALIZA√á√ÉO" ou "MAPA": envie a localiza√ß√£o no Google Maps
- Para emerg√™ncias, encaminhe para contato humano imediatamente

Responda de forma natural e conversacional, como um atendente experiente da ag√™ncia.`;

// Classe do servi√ßo de IA
class AIService {
    constructor() {
        this.provider = AI_CONFIG.provider;
        this.conversationHistory = new Map();
        
        if (this.provider === 'google' && AI_CONFIG.google.apiKey) {
            try {
                this.genAI = new GoogleGenerativeAI(AI_CONFIG.google.apiKey);
                this.model = this.genAI.getGenerativeModel({ 
                    model: AI_CONFIG.google.model,
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                });
                console.log('‚úÖ Google Gemini inicializado para Railway');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Gemini:', error.message);
                this.provider = 'fallback';
            }
        }
    }

    async generateResponse(userId, userMessage, context = {}) {
        try {
            if (!this.conversationHistory.has(userId)) {
                this.conversationHistory.set(userId, []);
            }
            
            const history = this.conversationHistory.get(userId);
            history.push({ role: 'user', content: userMessage });
            
            if (history.length > 10) {
                history.splice(0, history.length - 10);
            }

            let response;
            
            switch (this.provider) {
                case 'google':
                    response = await this.callGoogleGemini(userId, history, context);
                    break;
                case 'openai':
                    response = await this.callOpenAI(userId, history, context);
                    break;
                case 'anthropic':
                    response = await this.callAnthropic(userId, history, context);
                    break;
                default:
                    response = this.getFallbackResponse(userMessage);
            }

            if (response) {
                history.push({ role: 'assistant', content: response });
            }

            return response || this.getFallbackResponse(userMessage);

        } catch (error) {
            console.error('‚ùå Erro na AI:', error.message);
            return this.getFallbackResponse(userMessage);
        }
    }

    async callGoogleGemini(userId, history, context) {
        try {
            let prompt = SYSTEM_PROMPT + "\n\n";
            
            if (context.userState) {
                prompt += `CONTEXTO: Usu√°rio no estado "${context.userState.estado}", bot ${context.userState.botAtivo ? 'ativo' : 'inativo'}.\n\n`;
            }
            
            prompt += "HIST√ìRICO DA CONVERSA:\n";
            history.forEach(msg => {
                prompt += `${msg.role === 'user' ? 'Cliente' : 'TravelBot'}: ${msg.content}\n`;
            });
            
            prompt += "\nTravelBot:";

            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            return text.trim();
            
        } catch (error) {
            console.error('‚ùå Erro no Gemini:', error.message);
            if (error.message.includes('quota') || error.message.includes('limit')) {
                console.warn('‚ö† Rate limit do Gemini atingido');
            }
            throw error;
        }
    }

    async callOpenAI(userId, history, context) {
        if (!AI_CONFIG.openai.apiKey) {
            throw new Error('OpenAI API key n√£o configurada');
        }

        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...history
        ];

        if (context.userState) {
            messages[0].content += `\n\nCONTEXTO ATUAL: O usu√°rio est√° no estado "${context.userState.estado}" e o bot est√° ${context.userState.botAtivo ? 'ativo' : 'inativo'}.`;
        }

        const response = await axios.post(AI_CONFIG.openai.baseURL, {
            model: AI_CONFIG.openai.model,
            messages: messages,
            max_tokens: 500,
            temperature: 0.7
        }, {
            headers: {
                'Authorization': `Bearer ${AI_CONFIG.openai.apiKey}`,
                'Content-Type': 'application/json'
            },
            timeout: 15000
        });

        return response.data.choices[0].message.content;
    }

    async callAnthropic(userId, history, context) {
        if (!AI_CONFIG.anthropic.apiKey) {
            throw new Error('Anthropic API key n√£o configurada');
        }

        const messages = history.map(msg => ({
            role: msg.role === 'assistant' ? 'assistant' : 'user',
            content: msg.content
        }));

        const response = await axios.post(AI_CONFIG.anthropic.baseURL, {
            model: AI_CONFIG.anthropic.model,
            system: SYSTEM_PROMPT,
            messages: messages,
            max_tokens: 500
        }, {
            headers: {
                'x-api-key': AI_CONFIG.anthropic.apiKey,
                'anthropic-version': '2023-06-01',
                'Content-Type': 'application/json'
            },
            timeout: 15000
        });

        return response.data.content[0].text;
    }

    getFallbackResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        
        if (lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('custa')) {
            return `üí∞ PRE√áOS DE VISTOS TRAVEL BOSS

üáµüáπ Portugal:
‚Ä¢ Turismo: 700.000 KZ (normal) / 1.000.000 KZ (direto)
‚Ä¢ Trabalho: 950.000 KZ a 1.850.000 KZ
‚Ä¢ Estudante: 2.000.000 KZ
‚Ä¢ Sa√∫de: 800.000 KZ a 1.350.000 KZ

üáßüá∑ Brasil: 1.300.000 KZ a 1.650.000 KZ
üá∫üá∏ EUA: 1.150.000 KZ a 2.150.000 KZ
üá®üá¶ Canad√°: 1.150.000 KZ a 1.850.000 KZ

üìû Para informa√ß√µes detalhadas: ${config.empresa.telefone}
‚è∞ Hor√°rio: ${config.empresa.horario}`;
        }

        if (lowerMessage.includes('onde') || lowerMessage.includes('localiza√ß√£o') || lowerMessage.includes('endere√ßo') || lowerMessage.includes('mapa')) {
            return `üìç NOSSA LOCALIZA√á√ÉO

üè¢ Endere√ßo:
${config.empresa.endereco}

‚è∞ Hor√°rio:
${config.empresa.horario}

üìû Telefone:
${config.empresa.telefone}

üó∫ Google Maps:
${config.localizacao.googleMapsUrl}

üí° Estamos no 2¬∫ piso do Kikuxi Shopping, f√°cil acesso e estacionamento dispon√≠vel!`;
        }

        if (lowerMessage.includes('documento') || lowerMessage.includes('papel') || lowerMessage.includes('requisito')) {
            return `üìÑ DOCUMENTOS NECESS√ÅRIOS

üìã Documentos b√°sicos para visto:
‚Ä¢ Passaporte v√°lido (m√≠nimo 6 meses)
‚Ä¢ Fotos tipo passe recentes
‚Ä¢ Extractos banc√°rios
‚Ä¢ Comprovativo de rendimentos
‚Ä¢ Seguro de viagem

‚ö† Importante:
Os documentos podem variar conforme o pa√≠s e tipo de visto.

üìû Para lista completa espec√≠fica:
${config.empresa.telefone}

ü§ù Oferecemos an√°lise completa da documenta√ß√£o!`;
        }

        return `Sistema temporariamente em modo b√°sico.

üìû Para atendimento completo:
${config.empresa.telefone}

üìß Email:
${config.empresa.email}

‚è∞ Hor√°rio de atendimento:
${config.empresa.horario}

üí° Para reativar funcionalidades avan√ßadas: digite MENU`;
    }

    async analyzeIntent(message) {
        const intents = {
            greeting: ['oi', 'ol√°', 'bom dia', 'boa tarde', 'boa noite', 'hey', 'hello'],
            pricing: ['pre√ßo', 'precos', 'valor', 'quanto custa', 'custo', 'cobra'],
            countries: ['portugal', 'brasil', 'eua', 'usa', 'canada', 'europa'],
            documents: ['documento', 'papeis', 'requisitos', 'preciso', 'necess√°rio'],
            location: ['onde', 'localiza√ß√£o', 'endere√ßo', 'mapa'],
            contact: ['telefone', 'contato', 'atendente', 'falar', 'humano'],
            stop: ['parar', 'stop', 'sair', 'cancelar', 'encerrar'],
            image: ['imagem', 'logo'],
            gallery: ['galeria', 'fotos', 'imagens']
        };

        const lowerMessage = message.toLowerCase();
        
        for (const [intent, keywords] of Object.entries(intents)) {
            if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                return intent;
            }
        }
        
        return 'general';
    }

    clearHistory(userId) {
        this.conversationHistory.delete(userId);
    }

    getStats() {
        return {
            provider: this.provider,
            activeConversations: this.conversationHistory.size,
            totalHistorySize: Array.from(this.conversationHistory.values())
                .reduce((total, history) => total + history.length, 0)
        };
    }
}

// Analytics simples
class SimpleAnalytics {
    constructor() {
        this.stats = {
            totalMessages: 0,
            uniqueUsers: new Set(),
            aiResponses: 0,
            fallbackResponses: 0,
            imageRequests: 0,
            locationRequests: 0,
            galleryRequests: 0,
            errors: 0,
            startTime: Date.now()
        };
    }

    trackMessage(userId, isAI = false, type = 'text') {
        this.stats.totalMessages++;
        this.stats.uniqueUsers.add(userId);
        if (isAI) {
            this.stats.aiResponses++;
        } else {
            this.stats.fallbackResponses++;
        }
        if (type === 'image') this.stats.imageRequests++;
        if (type === 'location') this.stats.locationRequests++;
        if (type === 'gallery') this.stats.galleryRequests++;
    }

    trackError(error) {
        this.stats.errors++;
        console.error('üìä Error tracked:', error.message);
    }

    getStats() {
        const uptime = Math.floor((Date.now() - this.stats.startTime) / 1000 / 60);
        const aiSuccessRate = this.stats.totalMessages > 0 ? 
            ((this.stats.aiResponses / this.stats.totalMessages) * 100).toFixed(1) : '0';

        return {
            totalMessages: this.stats.totalMessages,
            uniqueUsers: this.stats.uniqueUsers.size,
            aiResponses: this.stats.aiResponses,
            fallbackResponses: this.stats.fallbackResponses,
            imageRequests: this.stats.imageRequests,
            locationRequests: this.stats.locationRequests,
            galleryRequests: this.stats.galleryRequests,
            errors: this.stats.errors,
            aiSuccessRate: `${aiSuccessRate}%`,
            uptime: `${uptime} minutos`
        };
    }
}

// Rate limiter
class SimpleRateLimiter {
    constructor() {
        this.requests = new Map();
        this.cleanup();
    }

    isAllowed(userId, maxRequests = 10, windowMs = 60000) {
        const now = Date.now();
        
        if (!this.requests.has(userId)) {
            this.requests.set(userId, []);
        }
        
        const userRequests = this.requests.get(userId);
        const validRequests = userRequests.filter(time => now - time < windowMs);
        
        if (validRequests.length >= maxRequests) {
            return false;
        }
        
        validRequests.push(now);
        this.requests.set(userId, validRequests);
        return true;
    }

    cleanup() {
        setInterval(() => {
            const cutoff = Date.now() - 300000;
            for (const [userId, requests] of this.requests.entries()) {
                const validRequests = requests.filter(time => time > cutoff);
                if (validRequests.length === 0) {
                    this.requests.delete(userId);
                } else {
                    this.requests.set(userId, validRequests);
                }
            }
        }, 300000);
    }
}

// Inicializa√ß√£o dos servi√ßos
const aiService = new AIService();
const analytics = new SimpleAnalytics();
const rateLimiter = new SimpleRateLimiter();
const userStates = new Map();

// Cliente WhatsApp com sess√£o persistente
const savedSession = loadSession();
const client = new Client({
    session: savedSession,
    puppeteer: puppeteerConfig
});

// Fun√ß√£o utilit√°ria
async function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Fun√ß√µes de m√≠dia
async function sendImage(msg, imagePath, caption) {
    try {
        if (!fs.existsSync(imagePath)) {
            console.warn(`‚ö† Imagem n√£o encontrada: ${imagePath}`);
            await msg.reply(`üì∑ ${caption}\n\n(Imagem temporariamente indispon√≠vel)`);
            return true;
        }
        const media = MessageMedia.fromFilePath(imagePath);
        await client.sendMessage(msg.from, media, { caption });
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar imagem:', error.message);
        analytics.trackError(error);
        return false;
    }
}

async function sendGallery(msg) {
    try {
        for (const imagePath of config.images.gallery) {
            if (fs.existsSync(imagePath)) {
                const media = MessageMedia.fromFilePath(imagePath);
                await client.sendMessage(msg.from, media, { caption: 'Travel Boss - Nosso espa√ßo' });
                await delay(2000);
            }
        }
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar galeria:', error.message);
        analytics.trackError(error);
        return false;
    }
}

async function sendLocation(msg) {
    try {
        const location = new Location(
            config.localizacao.latitude,
            config.localizacao.longitude,
            config.localizacao.nome
        );
        await client.sendMessage(msg.from, location);
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar localiza√ß√£o:', error.message);
        analytics.trackError(error);
        return false;
    }
}

// Eventos do cliente WhatsApp
client.on('qr', qr => {
    lastQR = qr;
    console.log('üîç QR Code recebido - acesse /qr no navegador');
    qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
    clientReady = true;
    lastQR = null;
    lastError = null;
    console.log('‚úÖ Travel Boss AI Bot conectado no Railway!');
    console.log(`üß† Provedor de IA: ${AI_CONFIG.provider.toUpperCase()}`);
    console.log(`üìä Modelo: ${AI_CONFIG[AI_CONFIG.provider].model}`);
    console.log('ü§ñ Sistema inteligente ativo e pronto para atender');
});

client.on('authenticated', (session) => {
    console.log('üîê WhatsApp autenticado com sucesso');
    saveSession(session);
});

client.on('auth_failure', msg => {
    clientReady = false;
    lastError = msg;
    console.error('‚ùå Falha na autentica√ß√£o WhatsApp:', msg);
    // Deletar sess√£o corrompida
    if (fs.existsSync(SESSION_FILE)) {
        fs.unlinkSync(SESSION_FILE);
        console.log('üóë Sess√£o corrompida removida');
    }
});

client.on('disconnected', reason => {
    clientReady = false;
    lastError = reason;
    console.warn('‚ö† WhatsApp desconectado:', reason);
    userStates.clear();
    
    // Tentar reconectar ap√≥s 10 segundos
    setTimeout(() => {
        console.log('üîÑ Tentando reconectar...');
        client.initialize();
    }, 10000);
});

// Processamento de mensagens
client.on('message', async msg => {
    try {
        if (msg.from.includes('@g.us') || msg.fromMe) return;
        
        const userId = msg.from;
        const userMessage = msg.body.trim();
        
        console.log(`üì© [${new Date().toLocaleTimeString()}] ${userId.split('@')[0]}: ${userMessage}`);

        if (!rateLimiter.isAllowed(userId, 10, 60000)) {
            await msg.reply("‚ö† Voc√™ est√° enviando mensagens muito rapidamente. Aguarde alguns segundos e tente novamente.");
            return;
        }

        if (!userStates.has(userId)) {
            userStates.set(userId, {
                botAtivo: false,
                estado: 'aguardando_inicio',
                ultimaInteracao: Date.now()
            });
        }

        const userState = userStates.get(userId);
        userState.ultimaInteracao = Date.now();

        const lowerMessage = userMessage.toLowerCase().trim();
        
        if (['parar', 'stop', 'sair', 'cancelar', 'encerrar'].includes(lowerMessage)) {
            userState.botAtivo = false;
            userState.estado = 'parado';
            aiService.clearHistory(userId);
            
            await msg.reply(`üî¥ Bot pausado com sucesso

Agora voc√™ pode conversar diretamente com nossa equipe:

üìû Telefone: ${config.empresa.telefone}
üìß Email: ${config.empresa.email}
‚è∞ Hor√°rio: ${config.empresa.horario}

üí° Para reativar o bot: digite OI, MENU ou INICIAR`);
            return;
        }

        const activationCommands = ['oi', 'ol√°', 'menu', 'iniciar', 'start', 'travel boss', 'bom dia', 'boa tarde', 'boa noite'];
        if (activationCommands.some(cmd => lowerMessage.includes(cmd))) {
            userState.botAtivo = true;
            userState.estado = 'ativo';
            
            const now = new Date().getHours();
            let greeting = 'Ol√°';
            if (now < 12) greeting = 'Bom dia';
            else if (now < 18) greeting = 'Boa tarde';
            else greeting = 'Boa noite';
            
            await msg.reply(`ü§ñ TravelBot Inteligente Ativado no Railway!

${greeting}! Bem-vindo √† Travel Boss! 

üåç‚úàÔ∏è Seja bem-vindo(a)! 
Sou seu assistente virtual com ü§ñ intelig√™ncia artificial, pronto para ajudar com tudo sobre **vistos e viagens**!  

üí° Voc√™ pode falar comigo de forma natural, como se fosse uma conversa. Estou aqui para facilitar seu processo e tirar todas as suas d√∫vidas!  

üìå Exemplos do que posso fazer por voc√™:  
üí∂ Informar quanto custa um visto para Portugal  
üìë Listar os documentos necess√°rios para o pedido  
üóìÔ∏è Explicar como funciona o agendamento  
üè¢ Mostrar a logo da nossa empresa  
üñºÔ∏è Exibir a galeria de fotos  

üëâ Digite **PARAR** a qualquer momento para falar com nossa equipe humana.`);

            analytics.trackMessage(userId, false);
            return;
        }

        if (!userState.botAtivo) {
            console.log(`üîá Bot inativo para usu√°rio ${userId.split('@')[0]} - mensagem ignorada`);
            return;
        }

        const intent = await aiService.analyzeIntent(userMessage);

        if (intent === 'image') {
            const success = await sendImage(msg, config.images.logo, 'Logo oficial da Travel Boss');
            if (success) {
                analytics.trackMessage(userId, false, 'image');
                await msg.reply('üì∑ Logo enviada! Deseja mais alguma coisa?');
            } else {
                await msg.reply('‚ùå Problema tempor√°rio com imagens. Contate nossa equipe.');
            }
            return;
        }

        if (intent === 'gallery') {
            await msg.reply('üì∏ Enviando galeria de fotos...');
            const success = await sendGallery(msg);
            if (success) {
                analytics.trackMessage(userId, false, 'gallery');
                await msg.reply('üì∏ Galeria enviada! Deseja mais alguma informa√ß√£o?');
            } else {
                await msg.reply('‚ùå Galeria temporariamente indispon√≠vel. Entre em contato!');
            }
            return;
        }

        if (intent === 'location') {
            await msg.reply(`üìç NOSSA LOCALIZA√á√ÉO

üè¢ Endere√ßo:
${config.empresa.endereco}

üó∫ Google Maps:
${config.localizacao.googleMapsUrl}

üí° Enviando localiza√ß√£o...`);
            const success = await sendLocation(msg);
            if (success) {
                analytics.trackMessage(userId, false, 'location');
                await msg.reply('üìç Localiza√ß√£o enviada! Estamos no 2¬∫ piso do Kikuxi Shopping. Como posso ajudar mais?');
            } else {
                await msg.reply('‚ùå Use o link do Google Maps acima para encontrar nossa localiza√ß√£o.');
            }
            return;
        }

        const startTime = Date.now();
        
        try {
            const aiResponse = await aiService.generateResponse(userId, userMessage, { userState });
            
            if (aiResponse) {
                await msg.reply(aiResponse);
                analytics.trackMessage(userId, true);
                console.log(`‚úÖ Resposta IA enviada em ${Date.now() - startTime}ms`);
            } else {
                throw new Error('Nenhuma resposta da IA');
            }
            
        } catch (error) {
            console.error(`‚ùå Erro ao processar mensagem para ${userId.split('@')[0]}:`, error.message);
            analytics.trackError(error);
            analytics.trackMessage(userId, false);
            
            await msg.reply(`‚ùå Sistema temporariamente sobrecarregado.

üìû Para atendimento imediato:
${config.empresa.telefone}

üí° Tente: digite MENU para recome√ßar`);
        }

    } catch (error) {
        console.error('‚ùå Erro geral no processamento:', error);
        analytics.trackError(error);
        
        try {
            await msg.reply("‚ùå Erro interno. Nossa equipe foi notificada. Tente novamente em alguns minutos.");
        } catch (replyError) {
            console.error('‚ùå Erro ao enviar mensagem de erro:', replyError);
        }
    }
});

// Comandos administrativos
client.on('message', async msg => {
    if (!msg.fromMe) return;
    
    const command = msg.body.toLowerCase().trim();
    
    switch (command) {
        case '!stats':
        case '!estatisticas':
            const stats = analytics.getStats();
            const aiStats = aiService.getStats();
            
            await msg.reply(`üìä ESTAT√çSTICAS RAILWAY BOT

üì® Mensagens:
‚Ä¢ Total: ${stats.totalMessages}
‚Ä¢ Usu√°rios √∫nicos: ${stats.uniqueUsers}

ü§ñ Performance IA:
‚Ä¢ Respostas IA: ${stats.aiResponses}
‚Ä¢ Respostas fallback: ${stats.fallbackResponses}
‚Ä¢ Pedidos de imagens: ${stats.imageRequests}
‚Ä¢ Pedidos de localiza√ß√£o: ${stats.locationRequests}
‚Ä¢ Pedidos de galeria: ${stats.galleryRequests}
‚Ä¢ Taxa sucesso IA: ${stats.aiSuccessRate}
‚Ä¢ Erros: ${stats.errors}

‚öô Sistema Railway:
‚Ä¢ Provedor: ${aiStats.provider.toUpperCase()}
‚Ä¢ Conversas ativas: ${aiStats.activeConversations}
‚Ä¢ Tempo ativo: ${stats.uptime}
‚Ä¢ WhatsApp: ${clientReady ? 'Conectado' : 'Desconectado'}

√öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}`);
            break;
            
        case '!health':
        case '!status':
            const uptime = process.uptime();
            const memory = process.memoryUsage();
            
            await msg.reply(`üè• STATUS RAILWAY

‚è± Uptime: ${Math.floor(uptime / 60)} minutos
üíæ Mem√≥ria: ${Math.round(memory.rss / 1024 / 1024)} MB
ü§ñ IA: ${AI_CONFIG.provider.toUpperCase()} - ${aiService.model ? 'Conectada' : 'Fallback'}
üì± WhatsApp: ${clientReady ? 'Conectado' : 'Reconectando...'}
üë• Usu√°rios ativos: ${userStates.size}
üåê Platform: Railway

Status geral: ‚úÖ Funcionando`);
            break;
            
        case '!clear':
            userStates.clear();
            aiService.conversationHistory.clear();
            await msg.reply(`üßπ LIMPEZA RAILWAY

‚Ä¢ Estados de usu√°rios limpos
‚Ä¢ Hist√≥rico de conversas limpo
‚Ä¢ Cache liberado
‚Ä¢ Mem√≥ria otimizada`);
            break;
            
        case '!railway':
        case '!info':
            await msg.reply(`üöÄ TRAVEL BOSS BOT - RAILWAY

üåê URL Base: https://your-app.railway.app
üìä Health: /health
üìà Status: /status
üîç QR Code: /qr

üîß Comandos Admin:
‚Ä¢ !stats - Estat√≠sticas completas
‚Ä¢ !health - Status do sistema
‚Ä¢ !clear - Limpar cache
‚Ä¢ !railway - Esta informa√ß√£o

Platform: Railway ‚úÖ
Version: 2.0.1 Production`);
            break;
    }
});

// Limpeza autom√°tica otimizada para Railway
setInterval(() => {
    const now = Date.now();
    const timeout = 2 * 60 * 60 * 1000; // 2 horas
    let cleaned = 0;
    
    for (const [userId, state] of userStates.entries()) {
        if (now - state.ultimaInteracao > timeout) {
            userStates.delete(userId);
            aiService.clearHistory(userId);
            cleaned++;
        }
    }
    
    if (cleaned > 0) {
        console.log(`üßπ Limpeza Railway: ${cleaned} usu√°rios inativos removidos`);
    }
    
    // For√ßa garbage collection se dispon√≠vel
    if (global.gc) {
        global.gc();
    }
}, 30 * 60 * 1000); // 30 minutos

// Tratamento graceful de encerramento (Railway)
process.on('SIGTERM', async () => {
    console.log('\nüõë SIGTERM recebido - Encerrando TravelBot Railway...');
    
    try {
        if (client && clientReady) {
            await client.destroy();
        }
        console.log('‚úÖ WhatsApp cliente desconectado');
        process.exit(0);
    } catch (error) {
        console.error('‚ùå Erro ao desconectar:', error);
        process.exit(1);
    }
});

process.on('SIGINT', async () => {
    console.log('\nüõë SIGINT recebido - Encerrando TravelBot Railway...');
    
    try {
        if (client && clientReady) {
            await client.destroy();
        }
        console.log('‚úÖ WhatsApp cliente desconectado');
        process.exit(0);
    } catch (error) {
        console.error('‚ùå Erro ao desconectar:', error);
        process.exit(1);
    }
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
    analytics.trackError(new Error(`Unhandled Rejection: ${reason}`));
});

process.on('uncaughtException', (error) => {
    console.error('‚ùå Uncaught Exception:', error);
    analytics.trackError(error);
});

// Inicializa√ß√£o otimizada para Railway
console.log('üöÄ Iniciando Travel Boss AI Bot no Railway...');
console.log(`üåç Environment: ${process.env.NODE_ENV || 'development'}`);
console.log(`üß† Provedor de IA: ${AI_CONFIG.provider.toUpperCase()}`);
console.log(`üîß Port: ${PORT}`);

if (AI_CONFIG.provider === 'google') {
    if (!AI_CONFIG.google.apiKey) {
        console.error('‚ùå GOOGLE_AI_KEY n√£o configurada!');
        console.log('üí° Configure: railway variables set GOOGLE_AI_KEY=sua_chave');
        console.log('üí° Obtenha chave gratuita em: https://makersuite.google.com/app/apikey');
        process.exit(1);
    }
    console.log('‚úÖ Google Gemini configurado para Railway (GRATUITO)');
} else if (AI_CONFIG.provider === 'openai') {
    if (!AI_CONFIG.openai.apiKey) {
        console.error('‚ùå OPENAI_API_KEY n√£o configurada!');
        console.log('üí° Configure: railway variables set OPENAI_API_KEY=sua_chave');
        process.exit(1);
    }
    console.log('‚úÖ OpenAI configurado para Railway');
}

console.log('üì± Sistema inteligente de conversa√ß√£o ativado');
console.log('üåê Health Check Server iniciado');
console.log('üîç Aguardando conex√£o WhatsApp...');
console.log('üì± Para ver QR Code: acesse /qr no navegador');

// Inicializar cliente WhatsApp
client.initialize();

module.exports = {
    client,
    aiService,
    analytics,
    config,
    app
};