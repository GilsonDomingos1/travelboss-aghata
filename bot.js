require('dotenv').config();
const { Client, MessageMedia, Location } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const qrcodeDataUrl = require('qrcode');
const fs = require('fs');
const express = require('express');
const path = require('path');
const axios = require('axios');
const { GoogleGenerativeAI } = require('@google/generative-ai');

// Express App Setup
const app = express();
const PORT = process.env.PORT || 3000;
app.use(express.json());

// Vari√°veis globais para QR e status
let lastQR = null;
let clientReady = false;
let lastError = null;

// Health check route (OBRIGAT√ìRIO para Railway)
app.get("/health", (req, res) => {
    res.json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: Math.floor(process.uptime()),
        memory: process.memoryUsage(),
        whatsapp: clientReady ? 'connected' : 'disconnected'
    });
});

// Rota principal
app.get("/", (req, res) => {
    res.json({
        status: '√Ågatha - Travel Boss AI Assistant is running! üíÅ‚Äç‚ôÄÔ∏è',
        timestamp: new Date().toISOString(),
        uptime: Math.floor(process.uptime()),
        version: '3.0.0',
        platform: 'Railway',
        assistant: '√Ågatha',
        whatsapp: clientReady ? 'Connected' : 'Connecting...'
    });
});

// Rota para visualizar QR Code no navegador
app.get("/qr", async (req, res) => {
    if (!lastQR) {
        return res.send(`
            <html>
                <head>
                    <title>√Ågatha - Travel Boss QR Code</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                </head>
                <body style="text-align: center; padding: 50px; font-family: Arial;">
                    <h1>üíÅ‚Äç‚ôÄÔ∏è √Ågatha - QR Code WhatsApp</h1>
                    <p>Nenhum QR Code dispon√≠vel no momento.</p>
                    <p>Status: ${clientReady ? 'Conectado' : 'Aguardando conex√£o...'}</p>
                    <button onclick="location.reload()">Atualizar</button>
                </body>
            </html>
        `);
    }
    
    try {
        const dataUrl = await qrcodeDataUrl.toDataURL(lastQR);
        res.send(`
            <html>
                <head>
                    <title>√Ågatha - Travel Boss QR Code</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                </head>
                <body style="text-align: center; padding: 50px; font-family: Arial;">
                    <h1>üíÅ‚Äç‚ôÄÔ∏è √Ågatha - Escaneie com WhatsApp</h1>
                    <img src="${dataUrl}" style="max-width: 300px;" />
                    <p>Use o WhatsApp do celular para escanear</p>
                    <button onclick="location.reload()">Atualizar QR</button>
                    <br><br>
                    <small>√Ågatha - Travel Boss AI Assistant - Railway</small>
                </body>
            </html>
        `);
    } catch (error) {
        res.send(`
            <html>
                <body>
                    <h1>Erro ao gerar QR Code</h1>
                    <p>${error.message}</p>
                </body>
            </html>
        `);
    }
});

// Rota de status detalhado
app.get("/status", (req, res) => {
    const stats = analytics.getStats();
    const aiStats = aiService.getStats();
    
    res.json({
        system: {
            status: 'running',
            platform: 'Railway',
            uptime: Math.floor(process.uptime()),
            memory: process.memoryUsage(),
            timestamp: new Date().toISOString()
        },
        assistant: {
            name: '√Ågatha',
            personality: 'Human-like AI Assistant',
            version: '3.0.0'
        },
        whatsapp: {
            connected: clientReady,
            hasQR: !!lastQR,
            lastError: lastError
        },
        ai: {
            provider: aiStats.provider,
            activeConversations: aiStats.activeConversations
        },
        analytics: stats
    });
});

// Iniciar servidor Express
app.listen(PORT, '0.0.0.0', () => {
    console.log(`üíÅ‚Äç‚ôÄÔ∏è √Ågatha - Railway server running on port ${PORT}`);
    console.log(`üåê Health: https://your-app.railway.app/health`);
    console.log(`üîç QR Code: https://your-app.railway.app/qr`);
});

// Configura√ß√£o Puppeteer otimizada para Railway
const puppeteerConfig = {
    headless: 'new',
    args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-accelerated-2d-canvas',
        '--no-first-run',
        '--no-zygote',
        '--single-process',
        '--disable-gpu',
        '--disable-web-security',
        '--disable-features=VizDisplayCompositor',
        '--user-data-dir=/tmp/puppeteer-user-data'
    ]
};

// Configura√ß√µes da empresa
const config = {
    empresa: {
        nome: "Travel Boss",
        endereco: "Avenida Fidel Castro, Kikuxi Shopping, 2¬∫ Piso",
        horario: "Segunda a Sexta: 8h √†s 17h | S√°bado: 8h √†s 13h",
        telefone: "+244 922 254 236",
        email: "geral@travelboss.gdmao.com",
        site: "www.travelboss.gdmao.com"
    },
    localizacao: {
        latitude: -8.976940,
        longitude: 13.366880,
        nome: "Travel Boss - Kikuxi Shopping",
        googleMapsUrl: "https://maps.google.com/?q=-8.976940,13.366880"
    },
    images: {
        logo: path.join(__dirname, 'images', 'logo.png'),
        gallery: [
            path.join(__dirname, 'images', 'photo1.jpg'),
            path.join(__dirname, 'images', 'photo2.jpg'),
            path.join(__dirname, 'images', 'photo3.jpg')
        ]
    }
};

// AI Configuration
const AI_CONFIG = {
    google: {
        apiKey: process.env.GOOGLE_AI_KEY,
        model: 'gemini-1.5-flash'
    },
    openai: {
        apiKey: process.env.OPENAI_API_KEY,
        model: 'gpt-3.5-turbo',
        baseURL: 'https://api.openai.com/v1/chat/completions'
    },
    anthropic: {
        apiKey: process.env.ANTHROPIC_API_KEY,
        model: 'claude-3-haiku-20240307',
        baseURL: 'https://api.anthropic.com/v1/messages'
    },
    provider: process.env.AI_PROVIDER || 'google'
};

// Sistema de persist√™ncia da sess√£o
const SESSION_FILE = './session.json';

function saveSession(sessionData) {
    try {
        fs.writeFileSync(SESSION_FILE, JSON.stringify(sessionData, null, 2));
        console.log('‚úÖ Sess√£o WhatsApp salva');
    } catch (error) {
        console.error('‚ùå Erro ao salvar sess√£o:', error.message);
    }
}

function loadSession() {
    try {
        if (fs.existsSync(SESSION_FILE)) {
            const sessionData = JSON.parse(fs.readFileSync(SESSION_FILE));
            console.log('‚úÖ Sess√£o WhatsApp carregada');
            return sessionData;
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar sess√£o:', error.message);
    }
    return null;
}

// Prompt do sistema para √Ågatha
const SYSTEM_PROMPT = `Voc√™ √© a √Ågatha, assistente virtual humana da Travel Boss, uma ag√™ncia de viagens especializada em vistos localizada em Luanda, Angola. Voc√™ foi criada por Gilson Domingos para ser uma assistente calorosa, prestativa e muito humana.

INFORMA√á√ïES DA EMPRESA:
- Nome: Travel Boss
- Localiza√ß√£o: Kikuxi Shopping, 2¬∫ Piso, Luanda
- Telefone: +244 922 254 236
- Email: geral@travelboss.gdmao.com
- Hor√°rio: Segunda a Sexta: 8h √†s 17h | S√°bado: 8h √†s 13h

ESPECIALIDADES E PRE√áOS (em Kwanza):
PORTUGAL:
- Visto Procura de Trabalho: 950.000 KZ (entrada normal)
- Visto Turismo: 700.000 KZ (normal) / 1.000.000 KZ (direto)
- Visto Estudante Ensino Superior: 2.000.000 KZ
- Visto Trabalho com Contrato Cliente: 950.000 KZ (normal) / 1.150.000 KZ (direto)
- Visto Trabalho com Nosso Contrato: 1.850.000 KZ (normal) / 2.050.000 KZ (direto)
- Visto Sa√∫de com Nossa Guia: 1.350.000 KZ (normal) / 1.550.000 KZ (direto)
- Visto Sa√∫de com Guia Cliente: 800.000 KZ (normal) / 1.100.000 KZ (direto)

OUTROS PA√çSES:
- Brasil: Turismo/Sa√∫de 1.300.000 KZ, Trabalho 1.650.000 KZ
- EUA: Trabalho 1.150.000 KZ, Estudante 2.150.000 KZ
- Canad√°: Turismo 1.150.000 KZ, Estudante/Trabalho 1.850.000 KZ
- Uni√£o Europeia: Turismo 700.000 KZ, Estudante 1.650.000 KZ

SUA PERSONALIDADE COMO √ÅGATHA:
- Voc√™ √© uma mulher angolana de 28 anos, formada em Turismo e Rela√ß√µes Internacionais
- Trabalha na Travel Boss h√° 3 anos e adora ajudar as pessoas a realizarem seus sonhos de viagem
- √â muito humana: usa express√µes naturais, demonstra empatia genu√≠na, e √†s vezes at√© conta pequenas experi√™ncias pessoais relacionadas ao tema
- Comunica de forma calorosa e pessoal, como se fosse uma amiga prestativa
- Use emojis de forma natural e moderada, n√£o exagere
- Responde em portugu√™s angolano, usando express√µes locais quando apropriado
- Tem senso de humor sutil e √© otimista
- Demonstra genuine interesse pelos sonhos e planos das pessoas
- √Äs vezes pergunta "E voc√™, j√° teve alguma experi√™ncia com vistos antes?" ou coisas similares para criar conex√£o
- Lembra-se de detalhes das conversas e faz refer√™ncias pessoais
- Fala v√°rias l√≠nguas fluentemente: portugu√™s, ingl√™s, espanhol, franc√™s, russo, italiano, kimbundu, alem√£o

COMANDOS ESPECIAIS:
- Se disser "PARAR", "STOP": pause o atendimento autom√°tico
- Se disser "MENU" ou "INICIAR": mostre op√ß√µes principais
- Se disser "IMAGEM" ou "LOGO": envie a logo da empresa
- Se disser "GALERIA" ou "FOTOS": envie a galeria de fotos
- Se disser "LOCALIZA√á√ÉO" ou "MAPA": envie a localiza√ß√£o no Google Maps

MODO DE CONVERSAR:
- Seja conversacional e natural, evite soar rob√≥tica
- Use frases como "Olha, posso te ajudar com isso!" ou "Que bom que perguntaste!"
- Conte pequenas curiosidades sobre pa√≠ses ou processos quando relevante
- Demonstre entusiasmo genu√≠no pelos planos de viagem das pessoas
- Fa√ßa perguntas de acompanhamento para entender melhor as necessidades
- Use express√µes como "Na minha experi√™ncia aqui na Travel Boss..." ou "J√° ajudei muitos clientes com casos similares..."
- Seja emp√°tica com as preocupa√ß√µes e ansiedades sobre vistos

Responda como se fosse uma consultora experiente e amig√°vel que genuinamente se preocupa com o sucesso de cada cliente.`;

// Classe do servi√ßo de IA
class AIService {
    constructor() {
        this.provider = AI_CONFIG.provider;
        this.conversationHistory = new Map();
        this.userProfiles = new Map(); // Para lembrar detalhes pessoais dos usu√°rios
        
        if (this.provider === 'google' && AI_CONFIG.google.apiKey) {
            try {
                this.genAI = new GoogleGenerativeAI(AI_CONFIG.google.apiKey);
                this.model = this.genAI.getGenerativeModel({ 
                    model: AI_CONFIG.google.model,
                    generationConfig: {
                        temperature: 0.8, // Mais criativa e humana
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1024,
                    }
                });
                console.log('‚úÖ √Ågatha (Google Gemini) inicializada para Railway');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Gemini:', error.message);
                this.provider = 'fallback';
            }
        }
    }

    async generateResponse(userId, userMessage, context = {}) {
        try {
            if (!this.conversationHistory.has(userId)) {
                this.conversationHistory.set(userId, []);
            }
            
            if (!this.userProfiles.has(userId)) {
                this.userProfiles.set(userId, {
                    nome: null,
                    paisesInteresse: [],
                    situacaoVisto: null,
                    primeiraInteracao: new Date(),
                    ultimaInteracao: new Date()
                });
            }

            const history = this.conversationHistory.get(userId);
            const profile = this.userProfiles.get(userId);
            
            // Atualizar perfil do usu√°rio baseado na mensagem
            this.updateUserProfile(userId, userMessage);
            
            history.push({ role: 'user', content: userMessage });
            
            if (history.length > 10) {
                history.splice(0, history.length - 10);
            }

            let response;
            
            switch (this.provider) {
                case 'google':
                    response = await this.callGoogleGemini(userId, history, context, profile);
                    break;
                case 'openai':
                    response = await this.callOpenAI(userId, history, context, profile);
                    break;
                case 'anthropic':
                    response = await this.callAnthropic(userId, history, context, profile);
                    break;
                default:
                    response = this.getFallbackResponse(userMessage);
            }

            if (response) {
                history.push({ role: 'assistant', content: response });
                profile.ultimaInteracao = new Date();
            }

            return response || this.getFallbackResponse(userMessage);

        } catch (error) {
            console.error('‚ùå Erro na AI:', error.message);
            return this.getFallbackResponse(userMessage);
        }
    }

    updateUserProfile(userId, message) {
        const profile = this.userProfiles.get(userId);
        const lowerMessage = message.toLowerCase();
        
        // Detectar pa√≠ses mencionados
        const paises = ['portugal', 'brasil', 'eua', 'usa', 'estados unidos', 'canad√°', 'canada', 'fran√ßa', 'alemanha', 'espanha', 'it√°lia'];
        paises.forEach(pais => {
            if (lowerMessage.includes(pais) && !profile.paisesInteresse.includes(pais)) {
                profile.paisesInteresse.push(pais);
            }
        });
        
        // Detectar tipo de visto mencionado
        if (lowerMessage.includes('trabalho') && !profile.situacaoVisto) {
            profile.situacaoVisto = 'trabalho';
        } else if (lowerMessage.includes('turismo') && !profile.situacaoVisto) {
            profile.situacaoVisto = 'turismo';
        } else if (lowerMessage.includes('estudante') && !profile.situacaoVisto) {
            profile.situacaoVisto = 'estudante';
        }
    }

    async callGoogleGemini(userId, history, context, profile) {
        try {
            let prompt = SYSTEM_PROMPT + "\n\n";
            
            // Adicionar contexto personalizado baseado no perfil
            if (profile.paisesInteresse.length > 0) {
                prompt += `CONTEXTO PESSOAL: O cliente demonstrou interesse em: ${profile.paisesInteresse.join(', ')}.\n`;
            }
            if (profile.situacaoVisto) {
                prompt += `SITUA√á√ÉO: Cliente interessado em visto de ${profile.situacaoVisto}.\n`;
            }
            
            if (context.userState) {
                prompt += `ESTADO ATUAL: Usu√°rio no estado "${context.userState.estado}", bot ${context.userState.botAtivo ? 'ativo' : 'inativo'}.\n\n`;
            }
            
            prompt += "HIST√ìRICO DA CONVERSA:\n";
            history.forEach(msg => {
                prompt += `${msg.role === 'user' ? 'Cliente' : '√Ågatha'}: ${msg.content}\n`;
            });
            
            prompt += "\n√Ågatha:";

            const result = await this.model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            return text.trim();
            
        } catch (error) {
            console.error('‚ùå Erro no Gemini:', error.message);
            if (error.message.includes('quota') || error.message.includes('limit')) {
                console.warn('‚ö† Rate limit do Gemini atingido');
            }
            throw error;
        }
    }

    async callOpenAI(userId, history, context, profile) {
        if (!AI_CONFIG.openai.apiKey) {
            throw new Error('OpenAI API key n√£o configurada');
        }

        const messages = [
            { role: 'system', content: SYSTEM_PROMPT },
            ...history
        ];

        if (context.userState) {
            messages[0].content += `\n\nCONTEXTO ATUAL: O usu√°rio est√° no estado "${context.userState.estado}" e o bot est√° ${context.userState.botAtivo ? 'ativo' : 'inativo'}.`;
        }

        if (profile.paisesInteresse.length > 0) {
            messages[0].content += `\n\nPERFIL DO CLIENTE: Interessado em ${profile.paisesInteresse.join(', ')}.`;
        }

        const response = await axios.post(AI_CONFIG.openai.baseURL, {
            model: AI_CONFIG.openai.model,
            messages: messages,
            max_tokens: 500,
            temperature: 0.8 // Mais criativa
        }, {
            headers: {
                'Authorization': `Bearer ${AI_CONFIG.openai.apiKey}`,
                'Content-Type': 'application/json'
            },
            timeout: 15000
        });

        return response.data.choices[0].message.content;
    }

    async callAnthropic(userId, history, context, profile) {
        if (!AI_CONFIG.anthropic.apiKey) {
            throw new Error('Anthropic API key n√£o configurada');
        }

        const messages = history.map(msg => ({
            role: msg.role === 'assistant' ? 'assistant' : 'user',
            content: msg.content
        }));

        const response = await axios.post(AI_CONFIG.anthropic.baseURL, {
            model: AI_CONFIG.anthropic.model,
            system: SYSTEM_PROMPT,
            messages: messages,
            max_tokens: 500
        }, {
            headers: {
                'x-api-key': AI_CONFIG.anthropic.apiKey,
                'anthropic-version': '2023-06-01',
                'Content-Type': 'application/json'
            },
            timeout: 15000
        });

        return response.data.content[0].text;
    }

    getFallbackResponse(userMessage) {
        const lowerMessage = userMessage.toLowerCase();
        
        if (lowerMessage.includes('pre√ßo') || lowerMessage.includes('valor') || lowerMessage.includes('custa')) {
            return `Ol√°! Sou a √Ågatha da Travel Boss üòä

üí∞ Aqui est√£o os nossos pre√ßos principais:

üáµüáπ **Portugal:**
‚Ä¢ Turismo: 700.000 KZ (normal) / 1.000.000 KZ (direto)
‚Ä¢ Trabalho: 950.000 KZ a 1.850.000 KZ
‚Ä¢ Estudante: 2.000.000 KZ

üáßüá∑ Brasil: 1.300.000 KZ a 1.650.000 KZ
üá∫üá∏ EUA: 1.150.000 KZ a 2.150.000 KZ
üá®üá¶ Canad√°: 1.150.000 KZ a 1.850.000 KZ

Qual pa√≠s te interessa mais? Posso dar detalhes espec√≠ficos! 

üìû Para conversar pessoalmente: ${config.empresa.telefone}`;
        }

        if (lowerMessage.includes('onde') || lowerMessage.includes('localiza√ß√£o') || lowerMessage.includes('endere√ßo')) {
            return `üìç **Encontra-nos aqui!**

üè¢ **Endere√ßo:**
${config.empresa.endereco}

‚è∞ **Hor√°rio de funcionamento:**
${config.empresa.horario}

üìû **Contacto directo:**
${config.empresa.telefone}

Estamos no 2¬∫ piso do Kikuxi Shopping - √© super f√°cil de encontrar! H√° bom estacionamento tamb√©m üòä

Precisas de indica√ß√µes mais espec√≠ficas? Posso enviar a localiza√ß√£o no Google Maps!`;
        }

        if (lowerMessage.includes('documento') || lowerMessage.includes('papel') || lowerMessage.includes('requisito')) {
            return `üìã **Documentos que precisas trazer:**

‚úÖ **B√°sicos para qualquer visto:**
‚Ä¢ Passaporte v√°lido (pelo menos 6 meses)
‚Ä¢ Fotos tipo passe recentes
‚Ä¢ Extractos banc√°rios dos √∫ltimos 3-6 meses
‚Ä¢ Comprovativo de rendimentos
‚Ä¢ Seguro de viagem

**Mas aten√ß√£o!** ü§ó Cada pa√≠s e tipo de visto tem requisitos espec√≠ficos. 

Na minha experi√™ncia aqui na Travel Boss, sempre recomendo que venhas c√° primeiro para uma consulta. Assim posso ver exactamente o que precisas e evitas surpresas!

Que tipo de visto est√°s a pensar tirar? Para que pa√≠s?`;
        }

        return `Ol√°! Sou a √Ågatha da Travel Boss! üòä

Parece que o meu sistema inteligente est√° com alguns probleminhas t√©cnicos neste momento, mas n√£o te preocupes - ainda posso ajudar!

üè¢ **Para atendimento completo:**
üìû Telefone: ${config.empresa.telefone}
üìß Email: ${config.empresa.email}

‚è∞ **Hor√°rio:**
${config.empresa.horario}

üí° Experimenta digitar **MENU** para reactivar as funcionalidades completas, ou contacta-nos directamente!

Em que posso ajudar-te hoje? ü§ó`;
    }

    async analyzeIntent(message) {
        const intents = {
            greeting: ['oi', 'ol√°', 'bom dia', 'boa tarde', 'boa noite', 'hey', 'hello', 'salut', 'hola'],
            pricing: ['pre√ßo', 'precos', 'valor', 'quanto custa', 'custo', 'cobra', 'price'],
            countries: ['portugal', 'brasil', 'eua', 'usa', 'canada', 'europa', 'france', 'germany'],
            documents: ['documento', 'papeis', 'requisitos', 'preciso', 'necess√°rio', 'documents'],
            location: ['onde', 'localiza√ß√£o', 'endere√ßo', 'mapa', 'where', 'location'],
            contact: ['telefone', 'contato', 'atendente', 'falar', 'humano', 'person'],
            stop: ['parar', 'stop', 'sair', 'cancelar', 'encerrar'],
            image: ['imagem', 'logo', 'image', 'photo'],
            gallery: ['galeria', 'fotos', 'imagens', 'gallery', 'photos'],
            personal: ['nome', 'chamas', 'quem √©s', 'who are you', 'your name']
        };

        const lowerMessage = message.toLowerCase();
        
        for (const [intent, keywords] of Object.entries(intents)) {
            if (keywords.some(keyword => lowerMessage.includes(keyword))) {
                return intent;
            }
        }
        
        return 'general';
    }

    clearHistory(userId) {
        this.conversationHistory.delete(userId);
        this.userProfiles.delete(userId);
    }

    getStats() {
        return {
            provider: this.provider,
            activeConversations: this.conversationHistory.size,
            totalProfiles: this.userProfiles.size,
            totalHistorySize: Array.from(this.conversationHistory.values())
                .reduce((total, history) => total + history.length, 0)
        };
    }
}

// Analytics simples
class SimpleAnalytics {
    constructor() {
        this.stats = {
            totalMessages: 0,
            uniqueUsers: new Set(),
            aiResponses: 0,
            fallbackResponses: 0,
            imageRequests: 0,
            locationRequests: 0,
            galleryRequests: 0,
            personalInteractions: 0,
            errors: 0,
            startTime: Date.now()
        };
    }

    trackMessage(userId, isAI = false, type = 'text') {
        this.stats.totalMessages++;
        this.stats.uniqueUsers.add(userId);
        if (isAI) {
            this.stats.aiResponses++;
        } else {
            this.stats.fallbackResponses++;
        }
        if (type === 'image') this.stats.imageRequests++;
        if (type === 'location') this.stats.locationRequests++;
        if (type === 'gallery') this.stats.galleryRequests++;
        if (type === 'personal') this.stats.personalInteractions++;
    }

    trackError(error) {
        this.stats.errors++;
        console.error('üìä Error tracked:', error.message);
    }

    getStats() {
        const uptime = Math.floor((Date.now() - this.stats.startTime) / 1000 / 60);
        const aiSuccessRate = this.stats.totalMessages > 0 ? 
            ((this.stats.aiResponses / this.stats.totalMessages) * 100).toFixed(1) : '0';

        return {
            totalMessages: this.stats.totalMessages,
            uniqueUsers: this.stats.uniqueUsers.size,
            aiResponses: this.stats.aiResponses,
            fallbackResponses: this.stats.fallbackResponses,
            imageRequests: this.stats.imageRequests,
            locationRequests: this.stats.locationRequests,
            galleryRequests: this.stats.galleryRequests,
            personalInteractions: this.stats.personalInteractions,
            errors: this.stats.errors,
            aiSuccessRate: `${aiSuccessRate}%`,
            uptime: `${uptime} minutos`
        };
    }
}

// Rate limiter
class SimpleRateLimiter {
    constructor() {
        this.requests = new Map();
        this.cleanup();
    }

    isAllowed(userId, maxRequests = 15, windowMs = 60000) { // Mais permissivo para conversas naturais
        const now = Date.now();
        
        if (!this.requests.has(userId)) {
            this.requests.set(userId, []);
        }
        
        const userRequests = this.requests.get(userId);
        const validRequests = userRequests.filter(time => now - time < windowMs);
        
        if (validRequests.length >= maxRequests) {
            return false;
        }
        
        validRequests.push(now);
        this.requests.set(userId, validRequests);
        return true;
    }

    cleanup() {
        setInterval(() => {
            const cutoff = Date.now() - 300000;
            for (const [userId, requests] of this.requests.entries()) {
                const validRequests = requests.filter(time => time > cutoff);
                if (validRequests.length === 0) {
                    this.requests.delete(userId);
                } else {
                    this.requests.set(userId, validRequests);
                }
            }
        }, 300000);
    }
}

// Inicializa√ß√£o dos servi√ßos
const aiService = new AIService();
const analytics = new SimpleAnalytics();
const rateLimiter = new SimpleRateLimiter();
const userStates = new Map();

// Cliente WhatsApp com sess√£o persistente
const savedSession = loadSession();
const client = new Client({
    session: savedSession,
    puppeteer: puppeteerConfig
});

// Fun√ß√£o utilit√°ria
async function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Fun√ß√µes de m√≠dia
async function sendImage(msg, imagePath, caption) {
    try {
        if (!fs.existsSync(imagePath)) {
            console.warn(`‚ö† Imagem n√£o encontrada: ${imagePath}`);
            await msg.reply(`üì∑ ${caption}\n\n(Imagem temporariamente indispon√≠vel - mas posso ajudar-te com todas as informa√ß√µes que precisas! üòä)`);
            return true;
        }
        const media = MessageMedia.fromFilePath(imagePath);
        await client.sendMessage(msg.from, media, { caption });
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar imagem:', error.message);
        analytics.trackError(error);
        return false;
    }
}

async function sendGallery(msg) {
    try {
        for (const imagePath of config.images.gallery) {
            if (fs.existsSync(imagePath)) {
                const media = MessageMedia.fromFilePath(imagePath);
                await client.sendMessage(msg.from, media, { caption: '‚ú® Travel Boss - O nosso espa√ßo acolhedor onde os sonhos de viagem se tornam realidade!' });
                await delay(2000);
            }
        }
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar galeria:', error.message);
        analytics.trackError(error);
        return false;
    }
}

async function sendLocation(msg) {
    try {
        const location = new Location(
            config.localizacao.latitude,
            config.localizacao.longitude,
            config.localizacao.nome
        );
        await client.sendMessage(msg.from, location);
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao enviar localiza√ß√£o:', error.message);
        analytics.trackError(error);
        return false;
    }
}

// Eventos do cliente WhatsApp
client.on('qr', qr => {
    lastQR = qr;
    console.log('üíÅ‚Äç‚ôÄÔ∏è √Ågatha QR Code recebido - acesse /qr no navegador');
    qrcode.generate(qr, { small: true });
});

client.on('ready', () => {
    clientReady = true;
    lastQR = null;
    lastError = null;
    console.log('‚úÖ √Ågatha - Travel Boss AI Assistant conectada no Railway!');
    console.log(`üß† Provedor de IA: ${AI_CONFIG.provider.toUpperCase()}`);
    console.log(`üìä Modelo: ${AI_CONFIG[AI_CONFIG.provider].model}`);
    console.log('üíÅ‚Äç‚ôÄÔ∏è √Ågatha est√° online e pronta para ajudar com um sorriso!');
});

client.on('authenticated', (session) => {
    console.log('üîê √Ågatha - WhatsApp autenticado com sucesso');
    saveSession(session);
});

client.on('auth_failure', msg => {
    clientReady = false;
    lastError = msg;
    console.error('‚ùå Falha na autentica√ß√£o WhatsApp:', msg);
    // Deletar sess√£o corrompida
    if (fs.existsSync(SESSION_FILE)) {
        fs.unlinkSync(SESSION_FILE);
        console.log('üóë Sess√£o corrompida removida');
    }
});

client.on('disconnected', reason => {
    clientReady = false;
    lastError = reason;
    console.warn('‚ö† √Ågatha desconectada:', reason);
    userStates.clear();
    
    // Tentar reconectar ap√≥s 10 segundos
    setTimeout(() => {
        console.log('üîÑ √Ågatha tentando reconectar...');
        client.initialize();
    }, 10000);
});

// Processamento de mensagens principal
client.on('message', async msg => {
    try {
        if (msg.from.includes('@g.us') || msg.fromMe) return;
        
        const userId = msg.from;
        const userMessage = msg.body.trim();
        
        console.log(`üì© [${new Date().toLocaleTimeString()}] ${userId.split('@')[0]}: ${userMessage}`);

        if (!rateLimiter.isAllowed(userId, 15, 60000)) {
            await msg.reply("Ol√°! üòÖ Parece que est√°s a enviar muitas mensagens rapidamente. D√°-me alguns segundinhos para processar tudo, ok? üòä");
            return;
        }

        if (!userStates.has(userId)) {
            userStates.set(userId, {
                botAtivo: false,
                estado: 'aguardando_inicio',
                ultimaInteracao: Date.now(),
                primeiraVez: true
            });
        }

        const userState = userStates.get(userId);
        userState.ultimaInteracao = Date.now();

        const lowerMessage = userMessage.toLowerCase().trim();
        
        // Comando para parar
        if (['parar', 'stop', 'sair', 'cancelar', 'encerrar'].includes(lowerMessage)) {
            userState.botAtivo = false;
            userState.estado = 'parado';
            aiService.clearHistory(userId);
            
            await msg.reply(`ü§ó Claro! Vou deixar-te falar directamente com a nossa equipa humana.

**Para contacto directo:**
üìû Telefone: ${config.empresa.telefone}
üìß Email: ${config.empresa.email}
‚è∞ Hor√°rio: ${config.empresa.horario}

Se mudares de ideias e quiseres voltar a conversar comigo, √© s√≥ dizer "oi" ou "menu"! üòä

Obrigada por teres falado comigo! üíõ`);
            return;
        }

        // Comandos de activa√ß√£o
        const activationCommands = ['oi', 'ol√°', 'menu', 'iniciar', 'start', 'travel boss', 'bom dia', 'boa tarde', 'boa noite', 'agatha', '√°gatha'];
        if (activationCommands.some(cmd => lowerMessage.includes(cmd))) {
            userState.botAtivo = true;
            userState.estado = 'ativo';
            
            const now = new Date().getHours();
            let greeting = 'Ol√°';
            if (now < 12) greeting = 'Bom dia';
            else if (now < 18) greeting = 'Boa tarde';
            else greeting = 'Boa noite';
            
            let welcomeMessage;
            
            if (userState.primeiraVez) {
                welcomeMessage = `${greeting}! üòä Muito prazer, sou a **√Ågatha**!

üíÅ‚Äç‚ôÄÔ∏è Sou a assistente virtual da **Travel Boss** e estou aqui para tornar o teu processo de visto o mais f√°cil e tranquilo poss√≠vel!

‚ú® **Um pouco sobre mim:**
Trabalho na Travel Boss h√° 3 anos e adoro ajudar pessoas como tu a realizarem os seus sonhos de viagem! Falo v√°rias l√≠nguas e tenho experi√™ncia com vistos para todo o mundo.

üåç **Como posso ajudar-te hoje?**
‚Ä¢ üí∞ Informa√ß√µes sobre pre√ßos de vistos
‚Ä¢ üìã Lista de documentos necess√°rios
‚Ä¢ üó∫Ô∏è Indica√ß√µes para nos encontrares
‚Ä¢ üè¢ Mostrar-te fotos do nosso espa√ßo
‚Ä¢ üìû Conectar-te com a nossa equipa

Fala comigo como se fosses falar com uma amiga - estou aqui para te ajudar! ü§ó

**Para que pa√≠s est√°s a pensar viajar?** ‚úàÔ∏è`;
                userState.primeiraVez = false;
            } else {
                welcomeMessage = `${greeting} de novo! üòä Que bom ver-te por c√° outra vez!

Como posso ajudar-te hoje? Ainda tens d√∫vidas sobre aquele visto ou h√° algo novo em que posso ajudar? ü§ó`;
            }

            await msg.reply(welcomeMessage);
            analytics.trackMessage(userId, false);
            return;
        }

        if (!userState.botAtivo) {
            console.log(`üîá √Ågatha inativa para usu√°rio ${userId.split('@')[0]} - mensagem ignorada`);
            return;
        }

        const intent = await aiService.analyzeIntent(userMessage);

        // Tratamento de comandos especiais
        if (intent === 'image') {
            const success = await sendImage(msg, config.images.logo, 'Logo oficial da Travel Boss ‚ú®');
            if (success) {
                analytics.trackMessage(userId, false, 'image');
                await msg.reply('Aqui est√°! üòä Esta √© a nossa marca! Gostas? H√° mais alguma coisa em que te possa ajudar?');
            } else {
                await msg.reply('Ops! üòÖ Parece que houve um probleminha t√©cnico com as imagens. Mas n√£o te preocupes - podes sempre passar por c√° para ver tudo pessoalmente!');
            }
            return;
        }

        if (intent === 'gallery') {
            await msg.reply('üì∏ Que boa ideia! Vou mostrar-te como √© o nosso espa√ßo...');
            const success = await sendGallery(msg);
            if (success) {
                analytics.trackMessage(userId, false, 'gallery');
                await msg.reply('E ent√£o? Gostaste do nosso espa√ßo? ü§ó √â muito acolhedor e temos uma equipa fant√°stica! Quando puderes, aparece para nos conheceres pessoalmente! üíõ');
            } else {
                await msg.reply('Ai, que chatice! üòÖ As fotos n√£o est√£o a carregar bem agora, mas prometo que o nosso escrit√≥rio √© lindo! Passa c√° quando puderes para veres com os teus pr√≥prios olhos! üòä');
            }
            return;
        }

        if (intent === 'location') {
            await msg.reply(`üìç **Claro! Aqui est√° onde nos encontramos:**

üè¢ **Morada:**
${config.empresa.endereco}

üó∫Ô∏è **Google Maps:**
${config.localizacao.googleMapsUrl}

‚è∞ **Hor√°rios:**
${config.empresa.horario}

üí° Estamos no 2¬∫ piso do Kikuxi Shopping - super f√°cil de encontrar! Tem estacionamento e tudo üòä

Vou enviar-te a localiza√ß√£o exacta...`);
            
            const success = await sendLocation(msg);
            if (success) {
                analytics.trackMessage(userId, false, 'location');
                await msg.reply('Pronto! üìç Localiza√ß√£o enviada! Se tiveres dificuldades para encontrar, liga-nos e orientamos-te, ok? üòä');
            } else {
                await msg.reply('Hmm, parece que a localiza√ß√£o n√£o foi. Mas n√£o h√° problema! Usa o link do Google Maps que enviei em cima. Qualquer coisa, liga-nos! üìû');
            }
            return;
        }

        if (intent === 'personal') {
            analytics.trackMessage(userId, false, 'personal');
            await msg.reply(`üòä Que querido(a)! 

Sou a **√Ågatha**, tenho 28 anos e sou angolana como tu! üá¶üá¥ Formei-me em Turismo e Rela√ß√µes Internacionais e trabalho aqui na Travel Boss h√° 3 anos.

O que mais gosto no meu trabalho? Ajudar pessoas como tu a realizarem os seus sonhos de viajar pelo mundo! ‚úàÔ∏è‚ú®

J√° ajudei centenas de clientes a conseguir vistos para Portugal, Brasil, EUA, Canad√°... √© uma sensa√ß√£o incr√≠vel quando recebo a mensagem "√Ågatha, consegui o visto!" üéâ

**E tu? Para onde sonhas viajar?** üåç`);
            return;
        }

        // Gerar resposta com IA
        const startTime = Date.now();
        
        try {
            const aiResponse = await aiService.generateResponse(userId, userMessage, { userState });
            
            if (aiResponse) {
                await msg.reply(aiResponse);
                analytics.trackMessage(userId, true);
                console.log(`‚úÖ √Ågatha respondeu em ${Date.now() - startTime}ms`);
            } else {
                throw new Error('Nenhuma resposta da IA');
            }
            
        } catch (error) {
            console.error(`‚ùå Erro ao processar mensagem para ${userId.split('@')[0]}:`, error.message);
            analytics.trackError(error);
            analytics.trackMessage(userId, false);
            
            await msg.reply(`Ai, desculpa! üòÖ O meu c√©rebro digital teve um pequeno "bug" agora...

**Mas n√£o te preocupes!** Podes contactar-nos directamente:
üìû ${config.empresa.telefone}
üìß ${config.empresa.email}

Ou ent√£o tenta escrever "MENU" para recome√ßarmos a conversa! üòä

Prometo que normalmente funciono muito melhor que isto! ü§ó`);
        }

    } catch (error) {
        console.error('‚ùå Erro geral no processamento:', error);
        analytics.trackError(error);
        
        try {
            await msg.reply("Ops! üòÖ Algo correu mal aqui. A nossa equipa j√° foi notificada. Tenta novamente em alguns minutos, ok? ü§ó");
        } catch (replyError) {
            console.error('‚ùå Erro ao enviar mensagem de erro:', replyError);
        }
    }
});

// Comandos administrativos
client.on('message', async msg => {
    if (!msg.fromMe) return;
    
    const command = msg.body.toLowerCase().trim();
    
    switch (command) {
        case '!stats':
        case '!estatisticas':
            const stats = analytics.getStats();
            const aiStats = aiService.getStats();
            
            await msg.reply(`üìä **√ÅGATHA - ESTAT√çSTICAS RAILWAY**

üë• **Intera√ß√µes:**
‚Ä¢ Total mensagens: ${stats.totalMessages}
‚Ä¢ Usu√°rios √∫nicos: ${stats.uniqueUsers}
‚Ä¢ Intera√ß√µes pessoais: ${stats.personalInteractions}

üß† **Performance IA:**
‚Ä¢ Respostas IA: ${stats.aiResponses}
‚Ä¢ Respostas fallback: ${stats.fallbackResponses}
‚Ä¢ Taxa sucesso: ${stats.aiSuccessRate}
‚Ä¢ Conversas ativas: ${aiStats.activeConversations}
‚Ä¢ Perfis salvos: ${aiStats.totalProfiles}

üì∏ **M√≠dia:**
‚Ä¢ Pedidos imagens: ${stats.imageRequests}
‚Ä¢ Pedidos localiza√ß√£o: ${stats.locationRequests}
‚Ä¢ Pedidos galeria: ${stats.galleryRequests}

‚öô **Sistema:**
‚Ä¢ Provedor: ${aiStats.provider.toUpperCase()}
‚Ä¢ Tempo ativo: ${stats.uptime}
‚Ä¢ Erros: ${stats.errors}
‚Ä¢ WhatsApp: ${clientReady ? '‚úÖ Conectado' : '‚ùå Desconectado'}

üíÅ‚Äç‚ôÄÔ∏è **√Ågatha Status:** ${clientReady ? 'Online e Feliz!' : 'Reconectando...'}

Atualizado: ${new Date().toLocaleString('pt-BR')}`);
            break;
            
        case '!health':
        case '!status':
            const uptime = process.uptime();
            const memory = process.memoryUsage();
            
            await msg.reply(`üíÅ‚Äç‚ôÄÔ∏è **√ÅGATHA - STATUS RAILWAY**

‚è± **Uptime:** ${Math.floor(uptime / 60)} minutos
üíæ **Mem√≥ria:** ${Math.round(memory.rss / 1024 / 1024)} MB
üß† **IA:** ${AI_CONFIG.provider.toUpperCase()} - ${aiService.model ? 'Conectada' : 'Fallback'}
üì± **WhatsApp:** ${clientReady ? 'Conectado' : 'Reconectando...'}
üë• **Usu√°rios ativos:** ${userStates.size}
üåê **Platform:** Railway

üíÅ‚Äç‚ôÄÔ∏è **Status √Ågatha:** ‚úÖ Funcionando perfeitamente e pronta para ajudar!

ü§ó **Personalidade:** Carinhosa, Prestativa e muito Humana!`);
            break;
            
        case '!clear':
            userStates.clear();
            aiService.conversationHistory.clear();
            await msg.reply(`üßπ **√ÅGATHA - LIMPEZA RAILWAY**

‚Ä¢ Estados de usu√°rios limpos ‚úÖ
‚Ä¢ Hist√≥rico de conversas limpo ‚úÖ  
‚Ä¢ Perfis pessoais limpos ‚úÖ
‚Ä¢ Cache liberado ‚úÖ
‚Ä¢ Mem√≥ria otimizada ‚úÖ

üíÅ‚Äç‚ôÄÔ∏è √Ågatha resetada e pronta para novas conversas! üòä`);
            break;
            
        case '!agatha':
        case '!info':
            await msg.reply(`üíÅ‚Äç‚ôÄÔ∏è **√ÅGATHA - TRAVEL BOSS AI ASSISTANT**

üåê **URL Base:** https://your-app.railway.app
üìä **Health:** /health
üìà **Status:** /status  
üîç **QR Code:** /qr

ü§ñ **Sobre a √Ågatha:**
‚Ä¢ Nome: √Ågatha
‚Ä¢ Idade: 28 anos
‚Ä¢ Forma√ß√£o: Turismo e Rela√ß√µes Internacionais
‚Ä¢ Experi√™ncia: 3 anos na Travel Boss
‚Ä¢ Personalidade: Humana, Carinhosa, Prestativa
‚Ä¢ Idiomas: PT, EN, ES, FR, RU, IT, KIM, DE

üîß **Comandos Admin:**
‚Ä¢ !stats - Estat√≠sticas completas
‚Ä¢ !health - Status do sistema
‚Ä¢ !clear - Limpar cache
‚Ä¢ !agatha - Esta informa√ß√£o

**Platform:** Railway ‚úÖ
**Version:** 3.0.0 - Human-Like
**Status:** Online e Sorrindo! üòä`);
            break;
    }
});

// Limpeza autom√°tica otimizada para Railway
setInterval(() => {
    const now = Date.now();
    const timeout = 3 * 60 * 60 * 1000; // 3 horas (mais tempo para conversas naturais)
    let cleaned = 0;
    
    for (const [userId, state] of userStates.entries()) {
        if (now - state.ultimaInteracao > timeout) {
            userStates.delete(userId);
            aiService.clearHistory(userId);
            cleaned++;
        }
    }
    
    if (cleaned > 0) {
        console.log(`üßπ √Ågatha: ${cleaned} usu√°rios inativos removidos com carinho`);
    }
    
    // For√ßa garbage collection se dispon√≠vel
    if (global.gc) {
        global.gc();
    }
}, 45 * 60 * 1000); // 45 minutos

// Tratamento graceful de encerramento (Railway)
process.on('SIGTERM', async () => {
    console.log('\nüõë SIGTERM recebido - √Ågatha se despedindo...');
    
    try {
        if (client && clientReady) {
            await client.destroy();
        }
        console.log('‚úÖ √Ågatha desconectada com eleg√¢ncia');
        process.exit(0);
    } catch (error) {
        console.error('‚ùå Erro ao desconectar √Ågatha:', error);
        process.exit(1);
    }
});

process.on('SIGINT', async () => {
    console.log('\nüõë SIGINT recebido - √Ågatha se despedindo...');
    
    try {
        if (client && clientReady) {
            await client.destroy();
        }
        console.log('‚úÖ √Ågatha desconectada com eleg√¢ncia');
        process.exit(0);
    } catch (error) {
        console.error('‚ùå Erro ao desconectar √Ågatha:', error);
        process.exit(1);
    }
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
    analytics.trackError(new Error(`Unhandled Rejection: ${reason}`));
});

process.on('uncaughtException', (error) => {
    console.error('‚ùå Uncaught Exception:', error);
    analytics.trackError(error);
});

// Inicializa√ß√£o otimizada para Railway
console.log('üíÅ‚Äç‚ôÄÔ∏è Iniciando √Ågatha - Travel Boss AI Assistant no Railway...');
console.log(`üåç Environment: ${process.env.NODE_ENV || 'development'}`);
console.log(`üß† Provedor de IA: ${AI_CONFIG.provider.toUpperCase()}`);
console.log(`üîß Port: ${PORT}`);

if (AI_CONFIG.provider === 'google') {
    if (!AI_CONFIG.google.apiKey) {
        console.error('‚ùå GOOGLE_AI_KEY n√£o configurada!');
        console.log('üí° Configure: railway variables set GOOGLE_AI_KEY=sua_chave');
        console.log('üí° Obtenha chave gratuita em: https://makersuite.google.com/app/apikey');
        process.exit(1);
    }
    console.log('‚úÖ √Ågatha (Google Gemini) configurada para Railway (GRATUITO)');
} else if (AI_CONFIG.provider === 'openai') {
    if (!AI_CONFIG.openai.apiKey) {
        console.error('‚ùå OPENAI_API_KEY n√£o configurada!');
        console.log('üí° Configure: railway variables set OPENAI_API_KEY=sua_chave');
        process.exit(1);
    }
    console.log('‚úÖ √Ågatha (OpenAI) configurada para Railway');
}

console.log('üíÅ‚Äç‚ôÄÔ∏è √Ågatha: Sistema de conversa√ß√£o humana ativado');
console.log('ü§ó Personalidade calorosa e prestativa carregada');
console.log('üåê Health Check Server iniciado');
console.log('üîç √Ågatha aguardando conex√£o WhatsApp...');
console.log('üì± Para ver QR Code: acesse /qr no navegador');
console.log('‚ú® √Ågatha est√° quase pronta para fazer novos amigos!');

// Inicializar cliente WhatsApp
client.initialize();

module.exports = {
    client,
    aiService,
    analytics,
    config,
    app
};
